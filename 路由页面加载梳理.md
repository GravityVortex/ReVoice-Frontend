# 路由页面加载梳理

## 为什么是 (landing) 而不是其他？
因为 路由组 (landing) 不影响 URL：
`(landing)` 文件夹被括号包裹 → 不会出现在 URL 中
访问 /zh 时，Next.js 查找 [locale] 下的 page.tsx
找到 `[locale]/(landing)/page.tsx `→ 匹配成功
同时收集路径上的所有 layout：
app/layout.tsx
app/[locale]/layout.tsx
app/[locale]/(landing)/layout.tsx

## 如果访问其他路径呢？
/zh/admin/credits → app/[locale]/(admin)/admin/credits/page.tsx
  收集 layout:
  - app/layout.tsx
  - app/[locale]/layout.tsx
  - app/[locale]/(admin)/layout.tsx

/zh/chat → app/[locale]/(chat)/chat/page.tsx
  收集 layout:
  - app/layout.tsx
  - app/[locale]/layout.tsx
  - app/[locale]/(chat)/layout.tsx

## 访问流程

当访问 `http://localhost:3000/` 时：

```
http://localhost:3000/
  ↓ 自动重定向到默认语言
http://localhost:3000/zh (或 /en)
```

## Layout 嵌套层级

从外到内的嵌套结构：

```
src/app/layout.tsx (根 Layout)
  ↓ children
src/app/[locale]/layout.tsx (语言 Layout)
  ↓ children
src/app/[locale]/(landing)/layout.tsx (Landing Layout)
  ↓ children
src/app/[locale]/(landing)/page.tsx (首页 Page)
```

## 详细执行流程

### 第一层：[src/app/layout.tsx](src/app/layout.tsx)

**职责：**
- 设置 HTML 基础结构（`<html>`, `<head>`, `<body>`）
- 加载全局字体（Noto Sans Mono, Merriweather, JetBrains Mono）
- 注入第三方服务（广告、分析、客服等脚本）
- 添加 NextTopLoader 进度条

**关键代码：**
```tsx
export default async function RootLayout({ children }) {
  return (
    <html>
      <head>...</head>
      <body>
        <NextTopLoader />
        {children}  // ← Next.js 自动注入下一层内容
      </body>
    </html>
  );
}
```

### 第二层：[src/app/[locale]/layout.tsx](src/app/[locale]/layout.tsx)

**职责：**
- 验证 locale 参数（zh, en 等）
- 设置国际化上下文（`NextIntlClientProvider`）
- 提供主题上下文（`ThemeProvider`）
- 提供应用上下文（`AppContextProvider`）
- 添加 Toast 通知组件

**关键代码：**
```tsx
export default async function LocaleLayout({ children, params }) {
  const { locale } = await params;

  return (
    <NextIntlClientProvider>
      <ThemeProvider>
        <AppContextProvider>
          {children}  // ← Next.js 自动注入下一层内容
          <Toaster />
        </AppContextProvider>
      </ThemeProvider>
    </NextIntlClientProvider>
  );
}
```

### 第三层：[src/app/[locale]/(landing)/layout.tsx](src/app/[locale]/(landing)/layout.tsx)

**职责：**
- 加载国际化翻译数据
- 动态加载主题布局组件（实际加载 `src/themes/default/layouts/landing.tsx`）
- 传递 header 和 footer 数据
- 添加语言检测器（`LocaleDetector`）

**关键代码：**
```tsx
export default async function LandingLayout({ children }) {
  const t = await getTranslations('landing');
  const Layout = await getThemeLayout('landing');

  return (
    <Layout header={...} footer={...}>
      <LocaleDetector />  {/* 语言检测，不匹配提示用户切换 */}
      {children}  // ← Next.js 自动注入页面内容
    </Layout>
  );
}
```

### 第四层：[src/app/[locale]/(landing)/page.tsx](src/app/[locale]/(landing)/page.tsx)

**职责：**
- 加载首页翻译数据
- 构建页面数据对象（hero, features, testimonials 等）
- 动态加载主题页面组件（实际加载 `src/themes/default/pages/landing.tsx`）

**关键代码：**
```tsx
export default async function LandingPage({ params }) {
  const t = await getTranslations('landing');
  const page = { hero: t.raw('hero'), ... };

  // 实际加载 src/themes/default/pages/landing.tsx，内含若干行page（相当于div）
  const Page = await getThemePage('landing');

  return <Page locale={locale} page={page} />;
}
```

## 关键概念

### 1. children 的传递机制

`children` 不是手动传递的，而是 **Next.js 框架自动注入**：

- 每层 layout 的 `children` 由 Next.js 根据文件系统路由自动构建
- 代表该 layout 包裹的子内容（下一层 layout 或 page）

### 2. 路由组 (Route Groups)

- 用括号包裹的文件夹：`(landing)`, `(admin)`, `(auth)` 等
- **不影响 URL 路径**，仅用于组织代码和共享 layout
- 例如：`src/app/[locale]/(landing)/page.tsx` → URL 是 `/zh`，不是 `/zh/landing`

### 3. 动态路由参数

- `[locale]` → 捕获语言代码（zh, en 等）
- 通过 `params` 传递给组件

### 4. 文件系统路由匹配

访问 `/zh` 时，Next.js 自动：
1. 查找匹配的 `page.tsx`：找到 `[locale]/(landing)/page.tsx`
2. 收集路径上所有 `layout.tsx`：
   - `app/layout.tsx`
   - `app/[locale]/layout.tsx`
   - `app/[locale]/(landing)/layout.tsx`
3. 从外到内嵌套渲染

## 完整渲染结构

```jsx
<html> {/* app/layout.tsx */}
  <body>
    <NextTopLoader />
    <NextIntlClientProvider> {/* app/[locale]/layout.tsx */}
      <ThemeProvider>
        <AppContextProvider>
          <Layout header={...} footer={...}> {/* app/[locale]/(landing)/layout.tsx */}
            <LocaleDetector />
            <Page page={...} /> {/* app/[locale]/(landing)/page.tsx */}
          </Layout>
          <Toaster />
        </AppContextProvider>
      </ThemeProvider>
    </NextIntlClientProvider>
  </body>
</html>
```

## 其他路由示例

### 访问 `/zh/admin/credits`

```
app/layout.tsx
  ↓
app/[locale]/layout.tsx
  ↓
app/[locale]/(admin)/layout.tsx
  ↓
app/[locale]/(admin)/admin/credits/page.tsx
```

### 访问 `/zh/chat`

```
app/layout.tsx
  ↓
app/[locale]/layout.tsx
  ↓
app/[locale]/(chat)/layout.tsx
  ↓
app/[locale]/(chat)/chat/page.tsx
```

## LocaleDetector 组件

位置：[src/shared/blocks/common/locale-detector.tsx](src/shared/blocks/common/locale-detector.tsx)

**作用：**
- 检测浏览器语言（`navigator.language`）
- 当浏览器语言 ≠ 网站语言时，显示切换提示横幅
- 记住用户选择（localStorage）
- 自动调整页面布局（避免横幅遮挡内容）

**工作流程：**
```
检测浏览器语言（如 zh）
  ↓
当前网站语言（如 en）
  ↓
浏览器语言 ≠ 网站语言？
  ↓ 是
显示横幅："检测到浏览器语言是中文，是否切换？"
  ↓
用户点击"切换" → 跳转到 /zh，保存偏好
用户点击"关闭" → 隐藏横幅，1天内不再提示
```

## 总结

Next.js App Router 通过**文件系统路由**自动管理页面渲染：
- Layout 嵌套由文件结构决定，无需手动配置
- `children` 由框架自动注入，代表下一层内容
- 路由组用于组织代码，不影响 URL
- 每层 layout 提供特定功能和上下文
